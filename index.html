<link rel="import" href="node_modules/web-presentation/dist/web-presentation.html">
<link rel="stylesheet" href="present.css">

<web-presentation>

  <web-slide-title>
		<h2> Async / Await </h2>
		<h3>Escape from callback hell</h3>
		<p><a href="http://twitter.com/antono/">Anton Vasiljev</a></p>
  </web-slide-title>

  <web-slide-title>
		<h2> Synchronous IO </h2>
		<h3> blocking </h3>
  </web-slide-title>

  <web-slide>
    <pre>
      <code class='ruby huge'>
        user  = User.by_email(email)
        blog  = Blog.by_user_id(user.id)
        posts = Post.all_by_blog_id(blog.id)

        puts posts
      </code>
    </pre>
  </web-slide>

  <web-slide-title>
		<h2> Classic Asynchronous IO </h2>
		<h3> non blocking </h3>
  </web-slide-title>

  <web-slide>
    <pre>
      <code class='javascript big'>
        User.byEmail(email, (user) => {
          console.log(user);
        })
      </code>
    </pre>
  </web-slide>

  <web-slide>
    <pre>
      <code class='javascript big'>
User.byEmail(email, (user) => {
  Blog.byUserId(user.id, (blog) => {
    Post.allByBlogId(blog.id, (posts) => {
      console.log(posts);
    })
  })
})
      </code>
    </pre>
  </web-slide>

  <web-slide-title style="background-image: url(images/problem1.png)">
    <h2> Problems? </h2>
  </web-slide-title>

  <web-slide>
    <ul>
      <li> Pyramid of doom </li>
      <li> try / catch </li>
      <li> git blame </li>
    </ul>
  </web-slide>

  <web-slide>
    <pre>
      <code class='javascript small'>
step1('yo!', (res1) => {
  step2(res1, (res2) => {
    step3(res2, (res3) => {
      step4(res3, (res4) => {
        step5(res4, (res5) => {
          step6(res5, (res6) => {
            step7(res6, (res7) => {
              ...
            })
          })
        })
      })
    })
  })
})
      </code>
    </pre>
  </web-slide>

  <web-slide>
    <pre>
      <code class='javascript big'>
try {
  setTimeout(function () {
    throw new Error('Hello Kitty')
  }, 0)
} catch (e) {
  console.log(e);
}
      </code>
    </pre>
  </web-slide>

  <web-slide>
    Uncaught Error: Hello Kitty
  </web-slide>

  <web-slide-title>
		<h2> Callbacks -> Promises </h2>
  </web-slide-title>

  <web-slide>
    <blockquote cite="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Promise">
      <p>
        The Promise object is used for deferred and asynchronous computations.
      </p>
      <p>
        A Promise represents an operation that hasn't completed yet,
        but is expected in the future.
      </p>
    </blockquote>
  </web-slide>


  <web-slide>
    <pre>
      <code class='javascript'>
step1()
  .then(step2)
  .then(step3)
  .then(step4)
  .then(step5)
  .then(step6)
  .catch(console.log.bind(console))
      </code>
    </pre>
  </web-slide>

  <web-slide>
    <h3> Typical step with callback </h3>
    <pre>
      <code class='javascript small'>
function step(url, cb) {
  getResultAsync(url, function(err, res) {
    if (result) {
      cb(null, res);
    } else {
      cb(new Error("HELLO"));
    }
  });
}
      </code>
    </pre>
  </web-slide>

  <web-slide>
    <h3> Typical step with Promise </h3>
    <pre>
      <code class='javascript small'>
function step(url) {
  return new Promise((resolve, reject) => {
    getResultAsync(url, (err, res) => {
      if (res) {
        resolve(res);
      } else {
        reject(err);
      }
    });
  });
}
      </code>
    </pre>
  </web-slide>

  <web-slide>
    <h2> Promises in the wild </h2>
    <pre>
      <code class='javascript'>
window.fetch('/')
  .then(response => response.text())
  .then(console.log.bind(console))
  .catch(console.log.bind(console))
      </code>
    </pre>
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">Fetch API</a>
  </web-slide>

  <web-slide-title>
		<h2> Promises + Generators </h2>
  </web-slide-title>

  <web-slide>
    <pre>
      <code class='javascript'>
        function stepX(url) {
          return window.fetch(url)
            .then(response => response.text());
        }
      </code>
    </pre>
  </web-slide>

  <web-slide>
    <pre>
      <code class='javascript'>
function * seqGet(start) {
  var res;
  res = yield step1(start);
  res = yield step2(res);
  res = yield step3(res);
  res = yield step4(res);
  res = yield step5(res);
}
      </code>
    </pre>
  </web-slide>

  <web-slide>
    <pre>
      <code class='javascript'>
const seq = seqGet()

Promise.resolve(true)
  .then(res => seq.next(res).value)
  .then(res => seq.next(res).value)
  .then(res => seq.next(res).value)
  .then(res => seq.next(res).value)
  .then(res => seq.next(res).value)
  .then(res => seq.next(res).value)
  .catch((err) => {
    console.log("Catced error", err.stack)
  })
      </code>
    </pre>
  </web-slide>

  <web-slide-title>
		<h2> Async / Await </h2>
  </web-slide-title>

  <web-slide>
    <pre>
      <code class='javascript'>
function stepX(url) {
  return fetch(url).then(resp => resp.text());
}
      </code>
    </pre>
  </web-slide>

  <web-slide>
    <pre>
      <code class='javascript'>
async function fetchTexts(url) {
  url = await step1(url);
  url = await step2(url);
  url = await step3(url);
  url = await step4(url);
  return "Last value: ${url}";
}
      </code>
    </pre>
  </web-slide>

  <web-slide>
    <pre>
      <code class='javascript'>
fetchTexts('http://antono.info/test/step1.txt')
      </code>
    </pre>
  </web-slide>

  <web-slide>
    <pre>
      <code class='javascript'>
fetchTexts('http://antono.info/test/step1.txt')
  .then(console.log.bind(console))
      </code>
    </pre>
  </web-slide>

  <web-presentation-progress></web-presentation-progress>
  <web-presentation-keyboardcontrols></web-presentation-keyboardcontrols>
</web-presentation>
